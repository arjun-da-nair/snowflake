USE SCHEMA upcoz.staging;

CREATE STAGE betsReport_stage
  URL = 's3://upcoz-analytics/dailyReports/betsReport'
  STORAGE_INTEGRATION = UPCOZ_ANALYTICS_S3_INTEGRATION_DAILY_REPORTS;


-- Create a file format
CREATE OR REPLACE FILE FORMAT betsReportformat
    TYPE=CSV,
    SKIP_HEADER=1,
    FIELD_DELIMITER=',',
    TRIM_SPACE=TRUE,
    FIELD_OPTIONALLY_ENCLOSED_BY='"',
    REPLACE_INVALID_CHARACTERS=TRUE,
    DATE_FORMAT=AUTO,
    TIME_FORMAT=AUTO,
    TIMESTAMP_FORMAT=AUTO;


drop table upcoz.staging.BETSREPORT_raw

create or replace TABLE UPCOZ.STAGING.BETSREPORT_raw (
    filename VARCHAR(16777216),
    file_row_number int,
    file_content_key VARCHAR(16777216),
    file_last_modified timestamp_ntz,
    start_scan_time timestamp_ltz,
	BETDATE TIMESTAMP_NTZ(9),
	EVENTDATE TIMESTAMP_NTZ(9),
	PRODUCTNAME VARCHAR(16777216),
	BETTYPE VARCHAR(16777216),
	BETSTATUS VARCHAR(16777216),
	RACECODE VARCHAR(16777216),
	USERNAME VARCHAR(16777216),
	USERTAGS VARCHAR(16777216),
	EMAIL VARCHAR(16777216),
	PHONE NUMBER(38,0),
	BETAMOUNT NUMBER(38,2),
	SPORT VARCHAR(16777216),
	COMPETITION VARCHAR(16777216),
	EVENTNUMBER NUMBER(38,0),
	EVENT VARCHAR(16777216),
	MARKET VARCHAR(16777216),
	SELECTIONNUMBER NUMBER(38,0),
	SELECTION VARCHAR(16777216),
	REFUNDID NUMBER(38,0),
	REFUNDAMOUNT NUMBER(38,2),
	RESULTID NUMBER(38,0),
	RESULTAMOUNT NUMBER(38,2),
	FREEBETAMOUNT NUMBER(38,2),
	BETID NUMBER(38,0),
	MEETINGGRADE VARCHAR(16777216),
	FIXEDODDS NUMBER(38,2)
);




create or replace TABLE UPCOZ.PRODUCTION.BETSREPORT_RAW (
	unique_id VARCHAR(16777216),
    filename VARCHAR(16777216),
    file_row_number int,
    file_content_key VARCHAR(16777216),
    file_last_modified timestamp_ntz,
    start_scan_time timestamp_ltz,
	BETDATE TIMESTAMP_NTZ(9),
	EVENTDATE TIMESTAMP_NTZ(9),
	PRODUCTNAME VARCHAR(16777216),
	BETTYPE VARCHAR(16777216),
	BETSTATUS VARCHAR(16777216),
	RACECODE VARCHAR(16777216),
	USERNAME VARCHAR(16777216),
	USERTAGS VARCHAR(16777216),
	EMAIL VARCHAR(16777216),
	PHONE NUMBER(38,0),
	BETAMOUNT NUMBER(38,2),
	SPORT VARCHAR(16777216),
	COMPETITION VARCHAR(16777216),
	EVENTNUMBER NUMBER(38,0),
	EVENT VARCHAR(16777216),
	MARKET VARCHAR(16777216),
	SELECTIONNUMBER NUMBER(38,0),
	SELECTION VARCHAR(16777216),
	REFUNDID NUMBER(38,0),
	REFUNDAMOUNT NUMBER(38,2),
	RESULTID NUMBER(38,0),
	RESULTAMOUNT NUMBER(38,2),
	FREEBETAMOUNT NUMBER(38,2),
	BETID NUMBER(38,0),
	MEETINGGRADE VARCHAR(16777216),
	FIXEDODDS NUMBER(38,2),
	LAST_UPDATED_TIMESTAMP TIMESTAMP_NTZ(9)
);

create pipe upcoz.staging.betsReport_pipe_raw auto_ingest=true as
copy into upcoz.staging.BETSREPORT_raw 
(filename, file_row_number, file_content_key, file_last_modified, start_scan_time,BETDATE,EVENTDATE,PRODUCTNAME,BETTYPE,BETSTATUS,RACECODE,USERNAME,
USERTAGS,EMAIL, PHONE, BETAMOUNT, SPORT, COMPETITION, EVENTNUMBER, EVENT, MARKET, SELECTIONNUMBER, SELECTION, REFUNDID, REFUNDAMOUNT, RESULTID, RESULTAMOUNT, FREEBETAMOUNT, BETID, MEETINGGRADE, FIXEDODDS
)
FROM
(
SELECT METADATA$FILENAME, METADATA$FILE_ROW_NUMBER, METADATA$FILE_CONTENT_KEY, METADATA$FILE_LAST_MODIFIED, METADATA$START_SCAN_TIME, 
t.$1, t.$2,t.$3,t.$4,t.$5,
t.$6, t.$7,t.$8,t.$9,t.$10,
t.$11, t.$12,t.$13,t.$14,t.$15,
t.$16, t.$17,t.$18,t.$19,t.$20,
t.$21, t.$22,t.$23,t.$24,t.$25,
t.$26
FROM @upcoz.staging.betsReport_stage  (file_format => betsReportformat) t
);

SHOW PIPES;


select * from upcoz.staging.BETSREPORT_raw 



DROP STREAM betsReportraw_stream;

CREATE OR REPLACE STREAM betsReport_raw_stream ON TABLE upcoz.staging.BETSREPORT_RAW;

SHOW STREAMS LIKE 'BETSREPORT_RAW_STREAM';



drop procedure staging.betsReport_raw_loadToProd();

create or replace procedure staging.betsReport_raw_loadToProd()
returns varchar not null
language sql

as

$$

begin

delete from upcoz.production.BETSREPORT_RAW
where unique_id in (
select CONCAT(file_content_key,'_',file_row_number) from upcoz.staging.BETSREPORT_RAW
);

INSERT INTO
  upcoz.production.BETSREPORT_RAW

  SELECT 
    CONCAT(file_content_key,'_',file_row_number) as unique_id,
    filename,
    file_row_number,
    file_content_key,
    file_last_modified,
    start_scan_time,
    BETDATE,
	EVENTDATE,
	PRODUCTNAME,
	BETTYPE,
	BETSTATUS,
	RACECODE,
	USERNAME,
	USERTAGS,
	EMAIL,
	PHONE,
	BETAMOUNT,
	SPORT,
	COMPETITION,
	EVENTNUMBER,
	EVENT,
	MARKET,
	SELECTIONNUMBER,
	SELECTION,
	REFUNDID,
	REFUNDAMOUNT,
	RESULTID,
	RESULTAMOUNT,
	FREEBETAMOUNT,
	BETID,
	MEETINGGRADE,
	FIXEDODDS,
    CURRENT_TIMESTAMP as LAST_UPDATED_TIMESTAMP

FROM upcoz.staging.BETSREPORT_RAW;

truncate upcoz.staging.BETSREPORT_RAW;

end;

$$

;



create or replace task UPCOZ.STAGING.BETSREPORT_RAW_LOADTOPROD_TASK
	warehouse=COMPUTE_WH
	schedule='5 minute'
    WHEN SYSTEM$STREAM_HAS_DATA('betsReport_raw_stream')
	AS call staging.BETSREPORT_RAW_LOADTOPROD();

--TRUNCATE upcoz.staging.BETSREPORT;

ALTER TASK UPCOZ.STAGING.BETSREPORT_RAW_LOADTOPROD_TASK RESUME;

USE DATABASE UPCOZ;
SHOW TASKS




